{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">ğŸ“Š Registros contables del archivo: {{ archivo.nombre_original }}</h2>

    <div id="spreadsheet"></div>

    <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'registros:lista_archivos' %}" class="btn btn-secondary">â¬… Volver</a>
        <button id="btn-guardar" class="btn btn-success">ğŸ’¾ Guardar cambios</button>
    </div>

    <div class="mt-3 text-center">
        <span id="mensaje" class="fw-semibold"></span>
    </div>
</div>

<!-- âœ… LibrerÃ­as Jspreadsheet -->
<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
<link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
<script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
<script src="https://jsuites.net/v4/jsuites.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const columnas = {{ columnas|safe }};
    const registros = {{ registros_json|safe }};
    const mensaje = document.getElementById("mensaje");

    const table = jspreadsheet(document.getElementById('spreadsheet'), {
        data: registros,
        columns: columnas.map(col => ({
            type: col === "valor" ? "numeric" : "text",
            title: col.charAt(0).toUpperCase() + col.slice(1),
            width: 140,
        })),
        allowInsertRow: true,
        allowDeleteRow: true,
        allowInsertColumn: false,
        csvFileName: "registros_{{ archivo.nombre_original }}",
        minDimensions: [columnas.length, registros.length + 1],
    });

    document.getElementById('btn-guardar').addEventListener('click', async () => {
        const datos = table.getData();
        mensaje.textContent = "ğŸ’¾ Guardando cambios...";
        mensaje.className = "text-info";

        try {
            const respuesta = await fetch("{% url 'registros:guardar_registros' archivo.pk %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify(datos)
            });

            const resultado = await respuesta.json();

            if (resultado.mensaje) {
                mensaje.textContent = resultado.mensaje;
                mensaje.className = "text-success";
            } else {
                mensaje.textContent = resultado.error || "âŒ Error al guardar los cambios.";
                mensaje.className = "text-danger";
            }
        } catch (e) {
            mensaje.textContent = "âš ï¸ Error de conexiÃ³n.";
            mensaje.className = "text-danger";
        }
    });
});
</script>
{% endblock %}
